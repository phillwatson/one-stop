title Consent Given

participant nordigen
participant scheduler
participant rail-service
participant database
participant sendEmail-service
participant broker

nordigen->rail-service:GET: /api/v1/rails/consents/NORDIGEN/response?ref=consentRef
activate rail-service
rail-service->database:UserConsent.findByReference(consentRef)
activate database
rail-service<--database:userConsent
deactivate database

rail-service->rail-service:update
rail-service->database:UserConsent.persist
rbox over rail-service,database#bee7ff:status="GIVEN"

scheduler<-rail-service:POLL_CONSENT(consentId)
activate scheduler
deactivateafter scheduler

rail-service->broker:CONSENT_GIVEN
activate broker
deactivateafter broker
rbox over sendEmail-service#bee7ff:{\n  userId: UUID\n  institutionId: String\n  institutionName: String\n  ...\n}
deactivateafter rail-service

space 2
broker->sendEmail-service:CONSENT_GIVEN
activate sendEmail-service
sendEmail-service->database:User.get(userId)
activate database
database-->sendEmail-service:user
deactivate database
sendEmail-service->sendEmail-service:send sendEmail\n"consent received ..."
deactivateafter sendEmail-service

