title Audit Reports

participant scheduler
participant AuditReportsScheduledTask
participant UserAuditReportsAdhocTask
participant AuditReportConfigRepository

participant AuditReportTemplate
participant NotificationService

participant broker

note over scheduler,AuditReportsScheduledTask#b7d6ff :The task is scheduled to run overnight.

scheduler->AuditReportsScheduledTask:run()
activate AuditReportsScheduledTask
AuditReportsScheduledTask->AuditReportConfigRepository:listUserIds()

activate AuditReportConfigRepository
note left of AuditReportConfigRepository:list the IDs of those user that hold\n at least one report configuration.
AuditReportsScheduledTask<--AuditReportConfigRepository:UUID[]
deactivate AuditReportConfigRepository

loop#ffd4d4 AuditReportsScheduledTask:for each user ID

AuditReportsScheduledTask->UserAuditReportsAdhocTask:queueTask(userId)
activate UserAuditReportsAdhocTask
UserAuditReportsAdhocTask->scheduler:USER_AUDIT_REPORTS(userId)
activate scheduler
deactivateafter scheduler
deactivateafter UserAuditReportsAdhocTask
end
deactivateafter AuditReportsScheduledTask


scheduler->UserAuditReportsAdhocTask:apply(userId)
activate UserAuditReportsAdhocTask

UserAuditReportsAdhocTask->AuditReportConfigRepository:listAuditReportConfigs(userId)
activate AuditReportConfigRepository
UserAuditReportsAdhocTask<--AuditReportConfigRepository:AuditReportConfig[]
deactivate AuditReportConfigRepository

loop#ffd4d4 AuditReportsScheduledTask:for each report config
UserAuditReportsAdhocTask->UserAuditReportsAdhocTask:findAuditReportTemplate(config.templateId)
activate UserAuditReportsAdhocTask
UserAuditReportsAdhocTask-->UserAuditReportsAdhocTask:template
deactivate UserAuditReportsAdhocTask

alt#lightblue template found
UserAuditReportsAdhocTask->AuditReportTemplate:template.run(config)
activate AuditReportTemplate
UserAuditReportsAdhocTask<--AuditReportTemplate:AuditReportIssue[]
deactivate AuditReportTemplate

UserAuditReportsAdhocTask->UserAuditReportsAdhocTask:addToIssues()
activate UserAuditReportsAdhocTask
space
deactivate UserAuditReportsAdhocTask

else#lightblue template not found
UserAuditReportsAdhocTask->UserAuditReportsAdhocTask:logMissingTemplate()
activate UserAuditReportsAdhocTask
space
deactivate UserAuditReportsAdhocTask
end

end
UserAuditReportsAdhocTask->broker:TRANSACTION_AUDIT(issues)
deactivate UserAuditReportsAdhocTask

space
NotificationService<-broker:TRANSACTION_AUDIT(issues)
activate NotificationService
NotificationService->NotificationService:sendEmail()
NotificationService->NotificationService:createNotification()
deactivateafter NotificationService
