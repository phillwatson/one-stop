
# One-Stop

---
## OpenId-Lib
A library to support for Open-Id Connect authentication.
It supports for most common Open-Id Connect Providers, and is largely
configuration based; using common code to implement the boilerplate
functionality for Auth-Code authentication.

## Configuration
The enum AuthProvider lists the supported Open-Id Connect Providers;
others may be added.

Each Auth Provider implementation will have a set of configuration
properties (mapped to the AuthProvider enum) to establish how to establish
a connection (secret keys), exchange auth-codes and retrieve public keys
for JWT verification. Most of these configurations will be located in
the provider's own "well-known" configuration URL.

Each entry in the configuration is:
```yaml
one-stop:
  auth:
    openid:
      google:
        config-uri: 'https://accounts.google.com/.well-known/openid-configuration'
        client-id: '284564870769-e3qm0g1dgim9kjd1gp3qmia610evn88a.apps.googleusercontent.com'
        client-secret: 'a secret value generated by the auth-provider'
        redirect-uri: 'http://localhost/api/v1/auth/validate/google'

      gitlab:
        config-uri: 'https://gitlab.com/.well-known/openid-configuration'
        client-id: '31673b3e2b7f9ab7992084452b178b45609b93278f77f4d312ad1cf6d246b981'
        client-secret: 'a secret value generated by the auth-provider'
        redirect-uri: 'http://localhost/api/v1/auth/validate/gitlab'
```
See `com.hillayes.openid.OpenIdConfiguration` for more detail.

### GitHub Auth Provider
The GitHub API does not fully support the Open-ID Connect API in that, it does
not return an ID-Token with user profile data. Instead, it returns just an
access-token. With that we can call the GitHub REST API to retrieve the user's
profile data.

**IMPORTANT:**
> Ideally, the user's email address should be provided in the claims of the ID-Token
(or the profile data) returned by the open-id provider. If not provided, no emails can
be delivered to the user until they supply an email address in their one-stop profile
settings.

> When the user authenticates via an open-id provider for the first time, their email
address is also used to match them to an existing record in the database; and the
user is logged in as that user.
If the email address is not provided by the open-id provider, a new user will be created.

> For GitHub that requires explicit action on the user's part, to allow access to
their email address:
> 1. In their GitHub email settings (https://github.com/settings/emails),
uncheck the "Keep my email address private"
> 2. Then, in their GitHub profile (https://github.com/settings/profile), select the
email address in the "Public email" drop-down.
> 3. Having authenticated once, they can make their email address private again.

## Adding a New Open-Id Connect Provider
For most providers only two classes need to be implemented; OpenIdFactory
and OpenIdAuth.

OpenIdFactory is a factory class for creating instances of the
openid-lib framework classes to support a given Auth Provider.
The instances will be added to the CDI context with the appropriate
NamedAuthProvider qualifier.

OpenIdAuth implements the auth-token exchange for a given Auth
Provider, utilising the qualified beans created by the OpenIdFactory.
It accepts the auth-code, supplied by the Auth Provider in the initial
stage of the auth-code flow, and exchanges it for an ID-Token (access and
refresh tokens are also included in the exchange response but these are
not used by the application). The ID-token is supplied as a signed JWT,
and its claims provide the information for the authenticated user.
This is parsed, and the signature verified using the Auth Provider's
public keys, before being returned to the caller.

The final part of the installation is to add the configuration
properties on the application.yaml (see above).

Possibly the simplest way of adding a new AuthProvider implementation
is to copy the package for an existing one (renaming the classes, etc.
as appropriate).

The redirect-uri in the configuration will be the same for each
Auth Provider implementation. Only the last element of the URI path
will differ. That element will be the value of the AuthProvider enum
value for the given implementation. That is used to allow our application
to select the correct Auth Provider implementation with which to
perform the auth-code token exchange.
